<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Breakout Infinity — Fixed</title>
<meta name="mobile-web-app-capable" content="yes">
<style>
:root{ --bg1:#071026; --bg2:#081827; --accent:#8be9ff; --muted:#9fb3c8; --ui:#14303b; }
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--muted);-webkit-font-smoothing:antialiased}
.app{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:10px}
.container{width:100%;max-width:1100px;background:rgba(255,255,255,0.01);border-radius:12px;overflow:hidden;display:flex;gap:12px}
.left{flex:1;padding:12px;position:relative}
canvas{width:100%;height:640px;border-radius:8px;touch-action:none;display:block;-webkit-user-select:none;user-select:none}
.hud{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
.chip{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:9px;color:var(--accent);font-weight:700}
.controls{margin-left:auto;display:flex;gap:8px}
.btn{background:linear-gradient(90deg,var(--accent),#6ef2d9);border:none;padding:8px 12px;border-radius:9px;color:#021018;cursor:pointer}
.btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.right{width:280px;padding:12px;display:flex;flex-direction:column;gap:10px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:10px;border-radius:10px}
.small{font-size:13px;color:var(--muted)}
.footer{font-size:12px;color:#7ea6b1;text-align:center;margin-top:8px}
input[type="text"]{width:100%;padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:#fff}
.fullBtn{margin-top:8px;padding:8px;border-radius:8px;border:0;background:#0b6b5a;color:#fff;cursor:pointer}
@media(max-width:900px){ .container{flex-direction:column} canvas{height:520px} .right{width:100%} }
</style>
</head>
<body>
<div class="app">
  <div class="container" id="gameWrap" role="application">
    <div class="left">
      <div class="hud" role="status" aria-live="polite">
        <div class="chip">Score: <span id="score">0</span></div>
        <div class="chip">Lives: <span id="lives">3</span></div>
        <div class="chip">Level: <span id="level">1</span></div>
        <div class="chip">High: <span id="high">0</span></div>
        <div class="controls">
          <button id="soundBtn" class="btn secondary" aria-pressed="false">Sound</button>
          <button id="pauseBtn" class="btn secondary">Pause</button>
          <button id="fsBtn" class="btn secondary">Enter Fullscreen</button>
        </div>
      </div>

      <canvas id="game" aria-label="Breakout canvas"></canvas>
      <div id="instantNote" style="position:absolute;left:12px;bottom:12px;color:rgba(255,255,255,0.6);font-size:12px">Drag to move • Space to release ball • Press P to pause</div>
    </div>

    <div class="right">
      <div class="card">
        <div style="font-weight:800;color:var(--accent)">Settings</div>
        <div class="small" style="margin-top:8px">Name (optional)</div>
        <input id="nameInput" placeholder="Player name" />
        <button id="enterFsMobile" class="fullBtn">Fullscreen (Mobile)</button>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="resetLb" class="btn secondary">Reset Leaderboard</button>
          <button id="clearHigh" class="btn secondary">Clear High</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800;color:var(--accent)">Leaderboard (local)</div>
        <div id="leader" class="small" style="margin-top:8px">—</div>
      </div>

      <div class="card footer">Polished physics, fixed collisions, timed power-ups, mobile fullscreen accessible.</div>
    </div>
  </div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

function resizeCanvas(){
  const deviceRatio = Math.min(window.devicePixelRatio || 1, 1.5);
  const logicalW = 800, logicalH = 560;
  const maxW = Math.min(window.innerWidth - 40, 980);
  const scale = Math.min(maxW / logicalW, (window.innerHeight - 160) / logicalH);
  const cssW = Math.round(logicalW * scale);
  const cssH = Math.round(logicalH * scale);
  canvas.style.width = cssW + 'px';
  canvas.style.height = cssH + 'px';
  canvas.width = Math.round(logicalW * deviceRatio);
  canvas.height = Math.round(logicalH * deviceRatio);
  ctx.setTransform(deviceRatio,0,0,deviceRatio,0,0);
  canvas.logicalW = logicalW;
  canvas.logicalH = logicalH;
  paddle.y = canvas.logicalH - 40;
  if(paddle.x + paddle.w > canvas.logicalW) paddle.x = canvas.logicalW - paddle.w;
}
window.addEventListener('resize', resizeCanvas);

let score = 0, lives = 3, level = 1;
let high = parseInt(localStorage.getItem('bb_high_v3') || '0', 10) || 0;
document.getElementById('high').innerText = high;
let running = true, paused = false;

let paddle = { w:120, h:12, x: 340, y: 520, color:'#6ef2d9', speed:14 };
let balls = [];

function spawnBall(x,y,vx,vy){ balls.push({ x: x ?? paddle.x + paddle.w/2, y: y ?? paddle.y - 12, r:8, vx: vx ?? (Math.random()*4-2), vy: vy ?? -6.2, stuck:true, prevX:0, prevY:0 }); }

let bricks = [], powerups = [], particles = [];
function generateLevel(lv){
  bricks = [];
  const rows = Math.min(6, 3 + Math.floor(lv/1));
  const cols = 10;
  const pad = 8;
  const areaW = canvas.logicalW - 80;
  const bw = Math.floor((areaW - (cols-1)*pad) / cols);
  const bh = Math.max(16, 26 - Math.floor(lv/2));
  const ox = 40, oy = 40;
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const tint = 20 + r*8;
      const col = `hsl(200 10% ${35 + tint}%)`;
      bricks.push({ x: ox + c*(bw+pad), y: oy + r*(bh+pad), w: bw, h: bh, hits: (r%4===0)?2:1, color: col, special: Math.random() < 0.06 });
    }
  }
}

const POWER_TYPES = ['life','wide','multi','slow'];
let activeEffects = {};

function maybeSpawnPower(x,y){ if(Math.random() > 0.16) return; const t = POWER_TYPES[Math.floor(Math.random()*POWER_TYPES.length)]; powerups.push({ x, y, w:18, h:18, type:t, vy:2.6 }); }
function applyPower(p){
  if(p.type === 'life'){ lives++; playPop('power'); }
  if(p.type === 'wide'){ paddle.w = Math.min(260, paddle.w + 40); activeEffects['wide'] = performance.now() + 10000; playPop('power'); }
  if(p.type === 'multi'){ spawnBall(p.x, p.y, (Math.random()*4-2), -6.2); spawnBall(p.x, p.y, (Math.random()*4-2), -6.2); playPop('power'); }
  if(p.type === 'slow'){ activeEffects['slow'] = performance.now() + 8000; playPop('power'); }
}

function spawnParticles(x,y,color,count){ for(let i=0;i<count;i++){ particles.push({ x, y, vx:(Math.random()-0.5)*2, vy:(Math.random()-0.8)*2, life:8 + Math.random()*10, color }); } }

function resetForLevel(lv){
  level = lv;
  paddle.w = Math.max(80, 120 - Math.floor(lv*3));
  paddle.x = Math.max(8, Math.min((canvas.logicalW - paddle.w)/2, canvas.logicalW - paddle.w -8));
  balls = [];
  spawnBall();
  powerups = []; particles = [];
  generateLevel(lv);
  updateUI();
}

function updateUI(){
  document.getElementById('score').innerText = score;
  document.getElementById('lives').innerText = lives;
  document.getElementById('level').innerText = level;
  document.getElementById('high').innerText = high;
  renderLeaderboard();
}
function saveLeaderboard(entry){ const key='bb_leader_v3'; const cur = JSON.parse(localStorage.getItem(key) || '[]'); cur.push(entry); cur.sort((a,b)=> (b.score||0)-(a.score||0)); localStorage.setItem(key, JSON.stringify(cur.slice(0,8))); }
function renderLeaderboard(){ const key='bb_leader_v3'; const cur = JSON.parse(localStorage.getItem(key) || '[]'); const el = document.getElementById('leader'); if(!cur.length){ el.innerText='No scores yet'; return;} el.innerHTML = cur.map((e,i)=>`${i+1}. ${e.name||'Anon'} — ${e.score} • L:${e.level}`).join('<br>'); }

window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function ensureAudio(){ if(audioCtx) return; try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); masterGain = audioCtx.createGain(); masterGain.gain.value = 0.8; masterGain.connect(audioCtx.destination); }catch(e){ audioCtx = null; } }
let audioCtx = null, masterGain = null, soundEnabled = false;
function playPop(type){
  if(!audioCtx || !soundEnabled) return;
  const now = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(masterGain);
  if(type==='paddle'){ o.type='square'; o.frequency.setValueAtTime(880, now); g.gain.setValueAtTime(0.0001, now); g.gain.linearRampToValueAtTime(0.06, now+0.002); g.gain.exponentialRampToValueAtTime(0.0001, now+0.08); }
  if(type==='brick'){ o.type='triangle'; o.frequency.setValueAtTime(520 + Math.random()*200, now); g.gain.setValueAtTime(0.0001, now); g.gain.linearRampToValueAtTime(0.06, now+0.002); g.gain.exponentialRampToValueAtTime(0.0001, now+0.12); }
  if(type==='power'){ o.type='sine'; o.frequency.setValueAtTime(1200, now); g.gain.setValueAtTime(0.0001, now); g.gain.linearRampToValueAtTime(0.06, now+0.002); g.gain.exponentialRampToValueAtTime(0.0001, now+0.12); }
  if(type==='die'){ o.type='sawtooth'; o.frequency.setValueAtTime(140, now); g.gain.setValueAtTime(0.0001, now); g.gain.linearRampToValueAtTime(0.06, now+0.002); g.gain.exponentialRampToValueAtTime(0.0001, now+0.18); }
  o.start(now); o.stop(now+0.12);
}

let lastTime = performance.now();

function step(now){
  if(!running || paused){ lastTime = now; requestAnimationFrame(step); return; }
  const dtMs = Math.min(32, now - lastTime); lastTime = now;
  const dt = dtMs / 16.666;
  update(dt);
  render();
  requestAnimationFrame(step);
}

function update(dt){
  const now = performance.now();
  if(activeEffects['wide'] && activeEffects['wide'] < now){ paddle.w = Math.max(120, paddle.w - 40); delete activeEffects['wide']; }
  if(activeEffects['slow'] && activeEffects['slow'] < now){ delete activeEffects['slow']; }
  const slowMultiplier = activeEffects['slow'] ? 0.75 : 1;
  keyboardAssist(dt);

  for(let bi=balls.length-1; bi>=0; bi--){
    const b = balls[bi];
    b.prevX = b.x; b.prevY = b.y;
    if(b.stuck){ b.x = paddle.x + paddle.w/2; b.y = paddle.y - b.r - 2; continue; }
    b.x += b.vx * dt * slowMultiplier; b.y += b.vy * dt * slowMultiplier;

    if(b.x - b.r < 0){ b.x = b.r; b.vx = Math.abs(b.vx); playPop('paddle'); }
    if(b.x + b.r > canvas.logicalW){ b.x = canvas.logicalW - b.r; b.vx = -Math.abs(b.vx); playPop('paddle'); }
    if(b.y - b.r < 0){ b.y = b.r; b.vy = Math.abs(b.vy); playPop('paddle'); }

    if(b.y - b.r > canvas.logicalH){ balls.splice(bi,1); playPop('die'); if(balls.length===0){ lives--; if(lives<=0){ gameOver(); return; } spawnBall(); } continue; }

    // swept paddle collision robust check
    const prevBelow = (b.prevY + b.r) > paddle.y;
    const nowBelow = (b.y + b.r) > paddle.y;
    if(!prevBelow && nowBelow && b.vy > 0){
      const t = (paddle.y - (b.prevY + b.r)) / ((b.y + b.r) - (b.prevY + b.r) || 1);
      const crossX = b.prevX + (b.x - b.prevX) * t;
      if(crossX > paddle.x - 2 && crossX < paddle.x + paddle.w + 2){
        const rel = (crossX - (paddle.x + paddle.w/2)) / (paddle.w/2);
        const angle = rel * 0.65;
        const speed = Math.max(6, Math.hypot(b.vx, b.vy));
        b.vx = speed * Math.sin(angle);
        b.vy = -Math.abs(speed * Math.cos(angle));
        const maxSpeed = 11 + level*0.4;
        const curSpeed = Math.hypot(b.vx, b.vy);
        if(curSpeed > maxSpeed){ const f = maxSpeed/curSpeed; b.vx *= f; b.vy *= f; }
        playPop('paddle');
        spawnParticles(b.x, b.y, '#a7fff0', 5);
      }
    }

    // brick collisions
    for(let i=bricks.length-1;i>=0;i--){
      const br = bricks[i];
      const nx = Math.max(br.x, Math.min(b.x, br.x + br.w));
      const ny = Math.max(br.y, Math.min(b.y, br.y + br.h));
      const dx = b.x - nx, dy = b.y - ny;
      if((dx*dx + dy*dy) < (b.r*b.r)){
        if(Math.abs(dx) > Math.abs(dy)) b.vx = -b.vx; else b.vy = -b.vy;
        br.hits = (br.hits || 1) - 1;
        score += 12;
        playPop('brick');
        spawnParticles(b.x,b.y,br.color,6);
        if(br.hits <= 0){
          maybeSpawnPower(br.x + br.w/2, br.y + br.h/2);
          bricks.splice(i,1);
          score += 18;
        }
        break;
      }
    }
  }

  for(let i=powerups.length-1;i>=0;i--){
    const p = powerups[i];
    p.y += p.vy * dt;
    if(p.y > canvas.logicalH + 20){ powerups.splice(i,1); continue; }
    if(p.y + p.h > paddle.y && p.x > paddle.x - 10 && p.x < paddle.x + paddle.w + 10){
      applyPower(p);
      powerups.splice(i,1);
    }
  }

  for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.life--; if(p.life<=0) particles.splice(i,1); }

  if(bricks.length === 0){ score += Math.max(0, 40 - level*2); level++; resetForLevel(level); }

  if(score > high){ high = score; try{ localStorage.setItem('bb_high_v3', String(high)); }catch(e){} }
  updateUI();
}

function render(){
  ctx.clearRect(0,0,canvas.logicalW,canvas.logicalH);
  ctx.fillStyle = '#071018';
  ctx.fillRect(0,0,canvas.logicalW,canvas.logicalH);

  for(const br of bricks){ ctx.fillStyle = br.color; ctx.fillRect(br.x, br.y, br.w, br.h); ctx.strokeStyle='rgba(0,0,0,0.06)'; ctx.strokeRect(br.x+1, br.y+1, br.w-2, br.h-2); }

  for(const p of powerups){ ctx.fillStyle = '#ddd'; ctx.fillRect(p.x - p.w/2, p.y - p.h/2, p.w, p.h); ctx.fillStyle = '#000'; ctx.fillText(p.type[0].toUpperCase(), p.x-3, p.y+4); }

  ctx.fillStyle = paddle.color; ctx.fillRect(paddle.x, paddle.y, paddle.w, paddle.h);

  for(const b of balls){ ctx.beginPath(); ctx.fillStyle = b.color || '#fff'; ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill(); }

  for(const p of particles){ ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 2, 2); }
}

let pointerId = null;
function getRect(){ return canvas.getBoundingClientRect(); }
function clientToLogical(x){ const r = getRect(); return (x - r.left) * (canvas.logicalW / r.width); }

canvas.addEventListener('pointerdown', e=>{ pointerId = e.pointerId; canvas.setPointerCapture(pointerId); const lx = clientToLogical(e.clientX); paddle.x = Math.max(8, Math.min(canvas.logicalW - paddle.w - 8, lx - paddle.w/2)); balls.forEach(b=>{ if(b.stuck) b.stuck = false; }); });
canvas.addEventListener('pointermove', e=>{ if(pointerId !== e.pointerId) return; const lx = clientToLogical(e.clientX); paddle.x = Math.max(8, Math.min(canvas.logicalW - paddle.w - 8, lx - paddle.w/2)); });
canvas.addEventListener('pointerup', e=>{ if(pointerId === e.pointerId){ canvas.releasePointerCapture(pointerId); pointerId = null; } });
canvas.addEventListener('pointercancel', ()=>{ pointerId = null; });

const keys = {};
window.addEventListener('keydown', e=>{ if(e.code === 'Space'){ balls.forEach(b=>{ if(b.stuck) b.stuck=false; }); e.preventDefault(); } if(e.code === 'KeyP'){ paused = !paused; document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause'; } if(e.code === 'KeyM'){ toggleSound(); } if(e.code === 'ArrowLeft') keys['ArrowLeft'] = true; if(e.code === 'ArrowRight') keys['ArrowRight'] = true; });
window.addEventListener('keyup', e=>{ if(e.code === 'ArrowLeft') keys['ArrowLeft'] = false; if(e.code === 'ArrowRight') keys['ArrowRight'] = false; });
function keyboardAssist(dt){ if(keys['ArrowLeft']) paddle.x -= paddle.speed * dt; if(keys['ArrowRight']) paddle.x += paddle.speed * dt; paddle.x = Math.max(8, Math.min(canvas.logicalW - paddle.w - 8, paddle.x)); }

document.getElementById('pauseBtn').addEventListener('click', ()=>{ paused = !paused; document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause'; });
document.getElementById('soundBtn').addEventListener('click', ()=>{ toggleSound(); });
document.getElementById('resetLb').addEventListener('click', ()=>{ if(!confirm('Reset leaderboard?')) return; localStorage.removeItem('bb_leader_v3'); renderLeaderboard(); });
document.getElementById('clearHigh').addEventListener('click', ()=>{ if(!confirm('Clear high score?')) return; localStorage.removeItem('bb_high_v3'); high=0; document.getElementById('high').innerText=0; });

function toggleSound(){ ensureAudio(); soundEnabled = !soundEnabled; document.getElementById('soundBtn').textContent = soundEnabled ? 'Sound On' : 'Sound'; if(soundEnabled && audioCtx) audioCtx.resume().catch(()=>{}); }

const fsBtn = document.getElementById('fsBtn');
const enterFsMobile = document.getElementById('enterFsMobile');
function requestFullscreen(){ const el = document.getElementById('gameWrap'); if(el.requestFullscreen) el.requestFullscreen(); else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen(); else if(el.msRequestFullscreen) el.msRequestFullscreen(); }
fsBtn.addEventListener('click', requestFullscreen); enterFsMobile.addEventListener('click', requestFullscreen);

function gameOver(){ running = false; playPop('die'); const entry = { name: (document.getElementById('nameInput').value || 'Player'), score, level, when: Date.now() }; saveLeaderboard(entry); renderLeaderboard(); setTimeout(()=>{ alert('Game Over — Score: ' + score + ' — High: ' + high); location.reload(); }, 300); }

resetForLevel(1);
lastTime = performance.now();
requestAnimationFrame(step);
</script>
</body>
</html>
